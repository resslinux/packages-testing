# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=m4
pkgver=cvs.readonly.r350.gd33357e2
pkgrel=1
pkgdesc="GNU macro processor"
url="http://www.gnu.org/software/m4"
#depends=
makedepends=('texinfo' 'rsync')
arch=('x86_64')
license=('GPL')
source=(git://git.sv.gnu.org/m4.git
        git://git.sv.gnu.org/gnulib.git)
md5sums=('SKIP'
         'SKIP')

pkgver() {
  cd "$pkgname"
  
  git describe --long --tags | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g'
}

prepare() {
  cd "$pkgname"
  
  sed -i -e "s/patch -s/patch/" "$srcdir"/gnulib/gnulib-tool
  
  sed -i -e "s/m4_pattern_forbid/#m4_pattern_forbid/" configure.ac
  #sed -i -e "s/M4_INIT/#M4_INIT/" configure.ac
  #sed -i -e "s/M4_EARLY/#M4_EARLY/" configure.ac
  sed -i -e "s/AC_CONFIG_LIBOBJ_DIR/#AC_CONFIG_LIBOBJ_DIR/" configure.ac
  
  sed -i -e "s/m4\/gnu\/Makefile//" configure.ac
  sed -i -e "s/tests\/gnu\/Makefile//" configure.ac
  
  echo "do it"
  read
  sed -i -e "s/SUBDIRS		= po m4\/gnu . doc tests\/gnu/SUBDIRS		= po . doc/" Makefile.am
}

build() {
  cd "$pkgname"
  
  #LIBS="-lrt"
  export PATCH=/usr/bin/patch
  
  ./bootstrap --skip-git --gnulib-srcdir="$srcdir/gnulib/"
  ./configure --prefix=/usr \
              --disable-gcc-warnings
  
  make
}

package() {
  cd "$pkgname"
  
  make install DESTDIR="$pkgdir"
  
  rm -rf "$pkgdir"/usr/lib/charset.alias
  rmdir -p "$pkgdir"/usr/lib 2>/dev/null
}
